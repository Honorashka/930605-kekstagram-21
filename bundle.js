(()=>{"use strict";(()=>{const e=["Сергей","Полина","Ксюша","Марина","Николай","Александр","Денис","Анотн"],t=["Все отлично","Моя бабушка случайно чихнула с фотоаппаратом в руках и у неё получилась фотография лучше.","В целом всё неплохо. Но не всё.","Когда вы делаете фотографию, хорошо бы убирать палец из кадра. В конце концов это просто непрофессионально.","Я поскользнулся на банановой кожуре и уронил фотоаппарат на кота и у меня получилась фотография лучше.","Лица у людей на фотке перекошены, как будто их избивают. Как можно было поймать такой неудачный момент?!"];window.hashtag={MIN_LENGTH_HASHTAG:2,MAX_LENGHT_HASHTAG:20},window.scale={STEP:25,MIN_SCALE:25,MAX_SCALE:100};const n=()=>{const n=[];for(let o=0;o<2;o++)n.push({avatar:"img/avatar-"+i(1,6)+".svg",message:r(t),name:r(e)});return n},o=[],i=(e,t)=>Math.floor(e+Math.random()*(t+1-e)),r=e=>e[i(0,e.length-1)];window.data={renderPhotoBlock:()=>{for(let e=0;e<25;e++)o.push({url:`photos/${e+1}.jpg`,description:"Описание фотографии",likes:i(15,200),comments:n()});return o}}})(),(()=>{const e="https://21.javascript.pages.academy/kekstagram/data",t=(t,n,o,i,r)=>{const s=new XMLHttpRequest;s.responseType="json",s.open(o,i),s.addEventListener("load",(function(){if(i===e){const e=s.response;200===s.status?t(s.response):n("Статус ответа"+s.status+" "+s.statusText),window.load={dataServerArr:e}}else t(s.response)})),s.addEventListener("error",(function(){n("Произошла ошибка соединения")})),s.addEventListener("timeout",(function(){n("Запрос не усел выполниться за "+s.timeout+"мс")})),s.timeout=1e4,s.send(r)};window.server={load:(n,o)=>{t(n,o,"GET",e)},upload:(e,n,o)=>{t(n,o,"POST","https://21.javascript.pages.academy/kekstagram",e)}}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content.querySelector(".picture"),n=document.querySelector(".social__comment"),o=document.querySelector(".social__comments"),i=document.createDocumentFragment(),r=e=>{const n=t.cloneNode(!0);return n.querySelector(".picture__img").src=e.url,n.querySelector(".picture__likes").textContent=e.likes,n.querySelector(".picture__comments").textContent=e.comments.length,n},s=function(t){for(let e=0;e<t.length;e++)i.appendChild(r(t[e]));e.appendChild(i)};window.server.load(s,(function(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),window.picture={renderComments:e=>{e.forEach((e=>{const t=n.cloneNode(!0);t.querySelector(".social__picture").src=e.avatar,t.querySelector(".social__picture").alt=e.name,t.querySelector(".social__text").textContent=e.message,o.appendChild(t),t.classList.add("hidden")}))},pictureNode:e,socialComments:o,successHundler:s}})(),(()=>{const e=document.querySelector(".big-picture"),t=document.querySelector(".big-picture__img").querySelector("img"),n=e.querySelector(".likes-count"),o=e.querySelector(".comments-count"),i=e.querySelector(".social__caption"),r=e.querySelector("#picture-cancel"),s=document.querySelector(".pictures"),c=e.querySelector(".comments-loader"),d=e.querySelector(".social__comments"),l=(r,s)=>{const l=r[s];t.src=l.url,n.textContent=l.likes,o.textContent=l.comments.length,i.textContent=l.description,window.picture.renderComments(l.comments),e.classList.remove("hidden"),c.classList.remove("hidden");let a=[];a=l.comments;const u=(e,t)=>{for(let n=0;n<e;n++)t[n].classList.remove("hidden")},w=d.querySelectorAll(".social__comment");let m=5;const p=(e,t,n)=>{e<t.length?(u(e,n),c.classList.remove("hidden")):(u(t.length,n),c.classList.add("hidden"))};p(m,w,w),c.addEventListener("click",(()=>{m+=5,p(m,a,w)}))};document.querySelector(".social__comment-count").classList.add("hidden");const a=e=>{const t=s.querySelectorAll(".picture");return Array.from(t).indexOf(e)},u=()=>{e.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),window.picture.socialComments.textContent="",window.preview.buttonPictureItems.removeEventListener("click",u),window.picture.pictureNode.removeEventListener("keydown",window.button.onButtonEscapeItem),window.picture.pictureNode.addEventListener("keydown",window.button.onButtonEnterItem)};window.preview={bigPicture:e,onItemOpen:e=>{window.picture.socialComments.textContent="",window.preview.buttonPictureItems.addEventListener("click",u),window.picture.pictureNode.addEventListener("keydown",window.button.onButtonEscapeItem),window.picture.pictureNode.removeEventListener("keydown",window.button.onButtonEnterItem);const t=e.target.closest(".picture");if(t){const e=a(t);document.querySelector("body").classList.add("modal-open");const n=window.load.dataServerArr;l(n,e)}},closeItems:u,buttonPictureItems:r,onFilterItemOpenClick:e=>{window.picture.socialComments.textContent="",window.preview.buttonPictureItems.addEventListener("click",u),window.picture.pictureNode.addEventListener("keydown",window.button.onButtonEscapeItem),window.picture.pictureNode.removeEventListener("keydown",window.button.onButtonEnterItem);const t=e.target.closest(".picture");if(t){const e=a(t);document.querySelector("body").classList.add("modal-open");const n=window.filter.preparedPosts;l(n,e)}},indexPictureImage:a,showBigPicture:l}})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},(()=>{const e=document.querySelector(".img-filters"),t=e.querySelector("#filter-default"),n=e.querySelector("#filter-random"),o=e.querySelector("#filter-discussed"),i=e.querySelectorAll(".img-filters__button");e.classList.remove("img-filters--inactive");const r=e=>{for(;document.querySelector(".picture");)document.querySelector(".picture").remove();window.picture.successHundler(e)},s=window.debounce((function(){i.forEach((e=>e.classList.remove("img-filters__button--active"))),t.classList.add("img-filters__button--active"),r(window.load.dataServerArr),window.picture.pictureNode.addEventListener("click",window.preview.onItemOpen),window.picture.pictureNode.removeEventListener("click",window.preview.onFilterItemOpenClick),window.picture.pictureNode.removeEventListener("keydown",window.button.onButtonFilterEnterItem)})),c=window.debounce((function(){i.forEach((e=>e.classList.remove("img-filters__button--active"))),n.classList.add("img-filters__button--active"),(()=>{const e=[...window.load.dataServerArr];e.sort((function(){return.5-Math.random()}));const t=e.slice(0,10);r(t),window.picture.pictureNode.removeEventListener("click",window.preview.onItemOpen),window.picture.pictureNode.removeEventListener("keydown",window.button.onButtonEnterItem),window.picture.pictureNode.addEventListener("keydown",window.button.onButtonFilterEnterItem),window.picture.pictureNode.addEventListener("click",window.preview.onFilterItemOpenClick),window.filter={preparedPosts:e}})()})),d=window.debounce((function(){i.forEach((e=>e.classList.remove("img-filters__button--active"))),o.classList.add("img-filters__button--active"),(()=>{const e=[...window.load.dataServerArr],t=e.sort((function(e,t){return e.comments.length>t.comments.length?-1:e.comments.length<t.comments.length?1:0}));r(t),window.picture.pictureNode.removeEventListener("keydown",window.button.onButtonEnterItem),window.picture.pictureNode.removeEventListener("click",window.preview.onItemOpen),window.picture.pictureNode.addEventListener("keydown",window.button.onButtonFilterEnterItem),window.picture.pictureNode.addEventListener("click",window.preview.onFilterItemOpenClick),window.filter={preparedPosts:e}})()}));t.addEventListener("click",s),n.addEventListener("click",c),o.addEventListener("click",d)})(),(()=>{const e="Escape",t=(e,t)=>{if("picture"===e.target.className){const n=e.target.querySelector(".picture");if("Enter"===e.key&&n){const e=window.preview.indexPictureImage(n),o=t;window.preview.showBigPicture(o,e),document.querySelector("body").classList.add("modal-open")}}};window.button={onButtonEscapeItem:t=>{t.key===e&&(window.preview.bigPicture.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),window.picture.socialComments.textContent="")},onButtonEnterItem:e=>{t(e,window.load.dataServerArr)},onButtonFilterEnterItem:e=>{t(e,window.filter.preparedPosts)},BUTTON_ESCAPE:e,onButtonEscapeCancel:e=>{e.key===window.button.BUTTON_ESCAPE&&document.activeElement!==window.validation.inputHashTags&&document.activeElement!==window.validation.textAreaComment&&window.effects.closeEditWindow()}}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=document.querySelector("main"),n=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error"),i=document.createDocumentFragment(),r=()=>{const e=n.cloneNode(!0);i.appendChild(e),t.appendChild(i),document.addEventListener("click",s),document.addEventListener("keydown",l)},s=()=>{document.querySelector(".success").remove(),document.removeEventListener("click",s),document.removeEventListener("keydown",l)},c=()=>{const e=o.cloneNode(!0);i.appendChild(e),t.appendChild(i),document.addEventListener("click",d),document.addEventListener("keydown",a)},d=()=>{document.querySelector(".error").remove(),document.removeEventListener("click",d),document.removeEventListener("keydown",a)},l=e=>{e.keyCode===window.button.BUTTON_ESCAPE&&s()},a=e=>{e.keyCode===window.button.BUTTON_ESCAPE&&d()};window.form={submitHundler:t=>{t.preventDefault(),window.server.upload(new FormData(e),r,c),window.effects.closeEditWindow()},onUploadError:c,uploadForm:e}})(),(()=>{const e=document.querySelector(".scale__control--value"),t=document.querySelector(".scale__control--smaller"),n=document.querySelector(".scale__control--bigger"),o=t=>{t-window.scale.STEP<window.scale.MIN_SCALE?(e.value=window.scale.MIN_SCALE+"%",window.effects.imgUploadPreview.style.transform=`scale(${window.scale.MIN_SCALE/100})`):t+window.scale.STEP>window.scale.MAX_SCALE?(e.value=window.scale.MAX_SCALE+"%",window.effects.imgUploadPreview.style.transform=`scale(${window.scale.MAX_SCALE/100})`):(e.value=t+"%",window.effects.imgUploadPreview.style.transform=`scale(${t/100})`)};window.adjustment={smallButtonScale:t,bigButtonScale:n,setScaleValueDown:()=>{const t=e.value;o(parseInt(t,10)-window.scale.STEP)},setScaleValueUp:()=>{const t=e.value;o(parseInt(t,10)+window.scale.STEP)},scaleValue:e}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".effect-level"),n=document.querySelectorAll(".effects__radio"),o=document.querySelector(".img-upload__preview").querySelector("img"),i=t.querySelector(".effect-level__line"),r=i.querySelector(".effect-level__pin"),s=i.querySelector(".effect-level__depth"),c=document.querySelector("#upload-cancel"),d=document.querySelector("#upload-file"),l=document.querySelector(".img-upload__overlay"),a=document.querySelector(".img-upload__start input[type=file]"),u=["effects__preview--none","effects__preview--chrome","effects__preview--sepia","effects__preview--marvin","effects__preview--phobos","effects__preview--heat"],w=()=>{l.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),d.value="",window.validation.inputHashTags.value="",window.validation.textAreaComment.value="",o.className="effects__preview--none",o.src="",o.style.transform="scale(1)",window.adjustment.scaleValue.value="100%",v(),window.validation.inputHashTags.removeEventListener("input",window.validation.onInputHashTags),window.form.uploadForm.removeEventListener("submit",window.form.submitHundler),document.removeEventListener("keydown",window.button.onButtonEscapeCancel),d.addEventListener("change",window.effects.openEditWindow),window.adjustment.smallButtonScale.removeEventListener("click",window.adjustment.setScaleValueDown),window.adjustment.bigButtonScale.removeEventListener("click",window.adjustment.setScaleValueUp)};a.addEventListener("change",(function(){const t=a.files[0],n=t.name.toLowerCase(),i=e.some((function(e){return n.endsWith(e)})),r=new FileReader;i?(r.addEventListener("load",(function(){o.src=r.result})),r.readAsDataURL(t)):(r.onerror=(d.removeEventListener("change",window.effects.openEditWindow),void window.form.onUploadError()),r.readAsText(t)),d.addEventListener("change",window.effects.openEditWindow)}));const m=(e,t)=>{e.addEventListener("click",(function(){o.className=t,p(),v()}))};for(let e=0;e<n.length;e++)m(n[e],u[e]),t.classList.add("hidden");const p=()=>{o.classList.contains("effects__preview--none")?o.style.filter="none":o.classList.contains("effects__preview--chrome")?o.style.filter=`grayscale(${parseFloat(r.style.left)/100})`:o.classList.contains("effects__preview--sepia")?o.style.filter=`sepia(${parseFloat(r.style.left)/100})`:o.classList.contains("effects__preview--marvin")?o.style.filter=`invert(${r.style.left})`:o.classList.contains("effects__preview--phobos")?o.style.filter=`blur(${parseFloat(r.style.left)/(100/3)}px)`:o.classList.contains("effects__preview--heat")&&(o.style.filter=`brightness(${Math.round(parseFloat(r.style.left)/50+1)})`)},v=()=>{o.classList.contains("effects__preview--none")?(t.classList.add("hidden"),o.style.filter="none"):o.classList.contains("effects__preview--^")||(r.style.left="100%",s.style.width="100%",t.classList.remove("hidden"))};r.addEventListener("mousedown",(e=>{const t=parseFloat(getComputedStyle(i).width);e.preventDefault();let n={x:e.clientX},o=!1;const c=e=>{e.preventDefault(),o=!0;const i=n.x-e.clientX;n={x:e.clientX};const c=(r.offsetLeft-i)/t;var d;c>=0&&c<=1&&(d=c,r.style.left=Math.round(100*d)+"%",s.style.width=Math.round(100*d)+"%",p())},d=e=>{if(e.preventDefault(),document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",d),o){const e=function(t){t.preventDefault(),r.removeEventListener("click",e)};r.addEventListener("click",e)}};document.addEventListener("mousemove",c),document.addEventListener("mouseup",d)})),window.effects={imgUploadPreview:o,uploadCancel:c,uploadFile:d,uploadOverlay:l,openEditWindow:()=>{l.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",window.button.onButtonEscapeCancel),window.validation.inputHashTags.addEventListener("input",window.validation.onInputHashTags),window.form.uploadForm.addEventListener("submit",window.form.submitHundler),d.removeEventListener("change",window.effects.openEditWindow),window.adjustment.smallButtonScale.addEventListener("click",window.adjustment.setScaleValueDown),window.adjustment.bigButtonScale.addEventListener("click",window.adjustment.setScaleValueUp),c.addEventListener("click",w),window.picture.pictureNode.addEventListener("keydown",window.button.onButtonEscapeItem)},closeEditWindow:w}})(),window.effects.uploadFile.addEventListener("change",window.effects.openEditWindow),window.picture.pictureNode.addEventListener("click",window.preview.onItemOpen),window.picture.pictureNode.addEventListener("keydown",window.button.onButtonEnterItem),(()=>{const e=document.querySelector(".text__hashtags"),t=document.querySelector(".text__description");window.validation={inputHashTags:e,onInputHashTags:()=>{const t=e.value.split(" ");for(let n=0;n<t.length;n++){const o=/^#[\w\d]*$/;if(o.test(t[n]),o.test(t[n]))if(t[n].length<=window.hashtag.MIN_LENGTH_HASHTAG)e.setCustomValidity("Добавьте "+(window.hashtag.MIN_LENGTH_HASHTAG-t[n].length)+" симв.");else if(t[n].length>window.hashtag.MAX_LENGHT_HASHTAG)e.setCustomValidity("Удалите "+(t[n].length-window.hashtag.MAX_LENGHT_HASHTAG)+" симв.");else if(t.length>=5)e.setCustomValidity("Можно указывать не более 5 хэштегов");else if(n>0)for(let o=1;o<=n;o++)String(t[n]).toLowerCase()===String(t[n-o]).toLowerCase()&&e.setCustomValidity("Хэштеги не должны повторятся");else e.setCustomValidity("");else e.setCustomValidity("Хэштег должен начинаться с #, и содержать только буквы и цифры.")}e.reportValidity()},textAreaComment:t}})()})();